/*
 *
 *
脚本功能：哔哩哔哩 获取视频下载地址
软件版本：
下载地址：
脚本作者：
更新时间：2025年
电报频道：https://t.me/GieGie777
问题反馈：
使用声明：此脚本仅供学习与交流，请在下载使用24小时内删除！请勿在中国大陆转载与贩卖！
*******************************
[rewrite_local]
# > 哔哩哔哩 点分享复制链接即可
^https:\/\/api\.biliapi\.net\/x\/share\/click url script-response-body https://raw.githubusercontent.com/WeiGiegie/666/main/blbldownload.js
^https:\/\/api\.bilibili\.com\/x\/share\/click url script-response-body https://raw.githubusercontent.com/WeiGiegie/666/main/blbldownload.js
[mitm]
hostname = api.biliapi.net, api.bilibili.com, bibz.me




*
*
*/


const $http=typeof $task!=="\x75\x6e\x64\x65\x66\x69\x6e\x65\x64"?$task:$httpClient;const $notifyFn=$notify?$notify:(title,subtitle,body,options)=>{console['\x6c\x6f\x67'](title,subtitle,body,options)};const $prefsFn=$prefs||{valueForKey:k=>typeof $persistentStore!=="\x75\x6e\x64\x65\x66\x69\x6e\x65\x64"?$persistentStore['\x72\x65\x61\x64'](k):null,setValueForKey:(v,k)=>typeof $persistentStore!=="\x75\x6e\x64\x65\x66\x69\x6e\x65\x64"?$persistentStore['\x77\x72\x69\x74\x65'](v,k):null};const respBody=$response?['\x62\x6f\x64\x79']||"\x7b\x7d";let dataObj;try{dataObj=JSON['\x70\x61\x72\x73\x65'](respBody)}catch(e){dataObj={}}const shareUrl=dataObj?['\x64\x61\x74\x61']?['\x63\x6f\x6e\x74\x65\x6e\x74']?['\x6d\x61\x74\x63\x68'](/https:\/\/b23\.tv\/\S+/)?.[0];if(!shareUrl){console['\x6c\x6f\x67']("\u672a\u627e\u5230\u5206\u4eab\u94fe\u63a5");$done({})}else{console['\x6c\x6f\x67']("\u5339\u914d\u5230\u5206\u4eab\u94fe\u63a5\x3a "+shareUrl);const linkCheckReq={url:"\x68\x74\x74\x70\x73\x3a\x2f\x2f\x62\x69\x62\x7a\x2e\x6d\x65\x2f\x61\x70\x69\x2f\x6c\x69\x6e\x6b\x2d\x63\x68\x65\x63\x6b",method:"\x50\x4f\x53\x54",headers:{"\x43\x6f\x6e\x74\x65\x6e\x74\x2d\x54\x79\x70\x65":"\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2f\x6a\x73\x6f\x6e","\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74":"\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x35\x2e\x30"},body:JSON['\x73\x74\x72\x69\x6e\x67\x69\x66\x79']({url:shareUrl})};$http['\x66\x65\x74\x63\x68'](linkCheckReq)['\x74\x68\x65\x6e'](linkCheckResp=>{let finalUrl;try{finalUrl=JSON['\x70\x61\x72\x73\x65'](linkCheckResp['\x62\x6f\x64\x79'])?['\x66\x69\x6e\x61\x6c\x55\x72\x6c']}catch(e){console['\x6c\x6f\x67'](e)}if(!finalUrl){$done({});return}console['\x6c\x6f\x67']("\u83b7\u53d6\u5230 \x66\x69\x6e\x61\x6c\x55\x72\x6c\x3a "+finalUrl);const extractorReq={url:"\x68\x74\x74\x70\x73\x3a\x2f\x2f\x62\x69\x62\x7a\x2e\x6d\x65\x2f\x61\x70\x69\x2f\x76\x69\x64\x65\x6f\x2d\x65\x78\x74\x72\x61\x63\x74\x6f\x72",method:"\x50\x4f\x53\x54",headers:{"\x43\x6f\x6e\x74\x65\x6e\x74\x2d\x54\x79\x70\x65":"\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2f\x6a\x73\x6f\x6e","\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74":"\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x35\x2e\x30"},body:JSON['\x73\x74\x72\x69\x6e\x67\x69\x66\x79']({inputValue:finalUrl,quality:"\x68\x69\x67\x68\x65\x73\x74"})};$http['\x66\x65\x74\x63\x68'](extractorReq)['\x74\x68\x65\x6e'](extractorResp=>{let videoUrl,title,quality,thumbnail,videoId;try{const obj=JSON['\x70\x61\x72\x73\x65'](extractorResp['\x62\x6f\x64\x79']);const info=obj?['\x66\x6f\x72\x6d\x61\x74\x73']?.[0];videoUrl=info?['\x76\x69\x64\x65\x6f\x55\x72\x6c'];title=obj?['\x74\x69\x74\x6c\x65']||"\u89e3\u6790\u7ed3\u679c";quality=info?['\x71\x75\x61\x6c\x69\x74\x79\x4c\x61\x62\x65\x6c']||info?['\x71\x75\x61\x6c\x69\x74\x79']||"\u672a\u77e5";thumbnail=obj?['\x74\x68\x75\x6d\x62\x6e\x61\x69\x6c']||"";videoId=obj?['\x64\x65\x74\x65\x63\x74\x65\x64\x49\x64']||videoUrl}catch(e){console['\x6c\x6f\x67'](e)}if(!videoUrl){$done({});return}let seen=$prefsFn['\x76\x61\x6c\x75\x65\x46\x6f\x72\x4b\x65\x79']("\x62\x69\x6c\x69\x5f\x73\x65\x65\x6e\x5f\x76\x69\x64\x65\x6f\x73")||"\x7b\x7d";try{seen=JSON['\x70\x61\x72\x73\x65'](seen)}catch(e){seen={}}const now=window["\x44\x61\x74\x65"]['\x6e\x6f\x77']();const lastTime=seen[videoId]||0;if(now-lastTime<60000){console['\x6c\x6f\x67']("\u89c6\u9891\x31\u5206\u949f\u5185\u5df2\u901a\u77e5\u8fc7\uff0c\u8df3\u8fc7\uff1a"+videoId);$done({});return}seen[videoId]=now;$prefsFn['\x73\x65\x74\x56\x61\x6c\x75\x65\x46\x6f\x72\x4b\x65\x79'](JSON['\x73\x74\x72\x69\x6e\x67\x69\x66\x79'](seen),"\x62\x69\x6c\x69\x5f\x73\x65\x65\x6e\x5f\x76\x69\x64\x65\x6f\x73");const proxyUrl=`https:$notifyFn("\x42\u7ad9\u89e3\u6790\u6210\u529f",`${title}[${quality}]`,"\ud83d\udc49\u70b9\u51fb\u4e0b\u8f7d\ud83d\udc48",{"\x6f\x70\x65\x6e\x2d\x75\x72\x6c":proxyUrl,"\x6d\x65\x64\x69\x61\x2d\x75\x72\x6c":thumbnail});$done({})},err=>{console['\x6c\x6f\x67']("\x76\x69\x64\x65\x6f\x2d\x65\x78\x74\x72\x61\x63\x74\x6f\x72 \u8bf7\u6c42\u5931\u8d25",err);$done({})})},err=>{console['\x6c\x6f\x67']("\x6c\x69\x6e\x6b\x2d\x63\x68\x65\x63\x6b \u8bf7\u6c42\u5931\u8d25",err);$done({})})}
